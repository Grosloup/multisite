{% extends "ZPBAdminBlogBundle:Layouts:master.html.twig" %}


{% set active_ss_menu = "new_art" %}

{% block content %}
        <div class="row">
            <div class="col-md-12">
                <div class="page-header">
                    <h2>Article <small>Rédaction</small></h2>
                </div>
            </div>

        </div>
        {{ form_start(form, {attr: {novalidate: 'novalidate'}}) }}
        <div class="row">
            <div class="col-md-6">

                {{ form_errors(form) }}
                <div class="form-group">
                    {{ form_label(form.title) }}
                    {{ form_widget(form.title, {"attr":{"class":"form-control"}}) }}
                    {{ form_errors(form.title) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.slug) }}
                    {{ form_widget(form.slug, {"attr":{"class":"form-control"}}) }}
                    {{ form_errors(form.slug) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.body) }}
                    {{ form_widget(form.body, {"attr":{"class":"form-control"}}) }}
                    {{ form_errors(form.body) }}
                </div>

                <div class="form-group">
                    {{ form_label(form.excerpt) }}
                    {{ form_widget(form.excerpt, {"attr":{"class":"form-control"}}) }}
                    {{ form_errors(form.excerpt) }}
                </div>
            </div>

            <div class="col-md-4">
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <label>Etat de l'article</label>
                    </div>
                    <div class="panel-body">
                        <h3 class="text-danger">{{ article.status }}</h3>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {{ form_label(form.category) }}
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            {{ form_widget(form.category, {"attr":{"class":"form-control"}}) }}
                            {{ form_errors(form.category) }}
                        </div>
                    </div>
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        {{ form_label(form.tags) }}
                    </div>
                    <div class="panel-body">
                        <div class="form-group">
                            {{ form_widget(form.tags) }}
                            <div class="tags" data-prototype="{{ form_widget(form.tags.vars.prototype)|e }}"></div>
                            {{ form_errors(form.tags) }}
                        </div>
                    </div>
                </div>
                <div class="form-group">
                    {{ form_widget(form.saveDraft, {"attr":{"class":"btn btn-primary"}})  }}
                </div>
                <div class="form-group">
                    {{ form_widget(form.savePublish, {"attr":{"class":"btn btn-primary"}})  }}
                </div>
                <div class="panel panel-default">
                    <div class="panel-heading">
                        <label>Enregistrer "à la une"</label>
                    </div>
                    <div class="panel-body">
                        {# TODO set front #}
                    </div>
                </div>
                <div class="form-group">
                    {{ form_widget(form.saveFront, {"attr":{"class":"btn btn-primary"}})  }}
                </div>
            </div>

            <div class="col-md-2"></div>

        </div>
        {{ form_end(form) }}

{% endblock %}
{% block footScripts %}
    {{ parent() }}
    <script src="/admin/js/vendor/tinymce/tinymce.min.js"></script>
    <script src="/admin/js/vendor/typeahead.bundle.js"></script>
    <script>
        var collectionHolder = $('div.tags');
        var protoHolder = $("#article_form_tags");
        var $addTagLink = $('<a href="#" class="add_tag_link btn btn-default">Ajouter un mot-clé</a>');
        var $newLinkLi = $('<div class="form-group"></div>').append($addTagLink);
        function addTagForm(collectionHolder, $newLinkLi) {
            var prototype = protoHolder.attr('data-prototype');
            var newForm = prototype.replace(/<label class=\"required\">__name__label__<\/label>/g, "");
            newForm = newForm.replace(/__name__/g, collectionHolder.children().length);
            var nf = $(newForm);
            var label = nf.find("label");
            var ipt = nf.find("input");
            var parent = label.parent();
            parent.addClass("form-group");
            ipt.addClass("form-control auto-comp");
            $newLinkLi.before(nf);
        }
        var substringMatcher = function(strs) {
            return function findMatches(q, cb) {
                var matches, substrRegex;
                matches = [];
                substrRegex = new RegExp(q, 'i');
                $.each(strs, function(i, str) {
                    if (substrRegex.test(str)) {
                        matches.push({ value: str });
                    }
                });
                cb(matches);
            };
        };
        var tags = [
            {%- for t in tags -%}
            "{{ t.name }}"{% if loop.last != true %}, {% endif %}
            {%- endfor -%}
        ];
        $(function(){
            tinymce.init({
                selector: "textarea#article_form_body",
                menubar: "tools table format view insert edit",
                statusbar : false,
                resize: false,
                language : 'fr_FR',
                plugins: 'image preview fullscreen link code table',
                toolbar: false,
                height: 350
            });
            tinymce.init({
                selector: "textarea#article_form_excerpt",
                menubar: "tools table format view insert edit",
                statusbar : false,
                resize: false,
                language : 'fr_FR',
                plugins: 'image preview fullscreen link code table',
                toolbar: false,
                height: 150
            });
            collectionHolder.append($newLinkLi);
            $addTagLink.on('click', function(e) {
                e.preventDefault();
                addTagForm(collectionHolder, $newLinkLi);
            });
            if(tags.length){
                $(".auto-comp").typeahead({
                    hint: true,
                    highlight: true,
                    minLength: 2
                }, {
                    name: 'tags',
                    displayKey: 'value',
                    source: substringMatcher(tags)
                });
            }

        });
    </script>

{% endblock %}
